# WTH Fitness App – Architecture

## 1. High-Level System Design
- **Frontend**: Next.js 15 (App Router) with TypeScript and Tailwind CSS. Client-side state is managed with React Context + server actions for authenticated requests.
- **Backend/API Gateway**: Google Apps Script deployed as a Web App. Acts as the authenticated REST API in front of Google Sheets.
- **Database**: Google Sheets document containing the tabs `Users`, `Classes`, `TestResults`, and `Standards`.
- **Authentication**: Email + password. Passwords are stored hashed (SHA-256 with a static pepper) in the `Users` sheet. Session tokens are signed JWT-like blobs issued by Apps Script using `Utilities.base64EncodeWebSafe`. Tokens include expiry and are validated by Apps Script for protected operations.

```
Next.js (Vercel)  <--fetch-->  Google Apps Script Web App  <--SheetsApp-->  Google Sheets
```

## 2. Google Sheets Data Model

| Sheet        | Columns (order)                                                                                                                                 | Notes                                                                                                  |
|--------------|--------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------|
| `Users`      | `id`, `role` (`student` \| `instructor`), `full_name`, `email`, `password_hash`, `gender`, `birthdate`, `class_id`, `created_at`, `updated_at`   | `id` is ULID generated by Apps Script. `class_id` optional for instructors. Birthdate stored as ISO.   |
| `Classes`    | `id`, `instructor_id`, `class_name`, `class_code`, `created_at`                                                                                  | `class_code` is 6-char alphanumeric generated by Apps Script.                                         |
| `TestResults`| `id`, `user_id`, `test_type`, `recorded_at` (ISO), `value`, `derived_value` (for BMI, grip ratio), `evaluation`, `notes`                         | `evaluation` is string (Excellent, Good, Fair, Below Average, Poor).                                   |
| `Standards`  | `id`, `test_type`, `gender`, `age_min`, `age_max`, `category`, `min_value`, `max_value`, `comparison`                                           | `comparison`: `"range"` or `"threshold"` to support inclusive bounds. `min/max` stored as numbers.     |

## 3. Google Apps Script API

### Configuration
- `SHEET_ID`: Spreadsheet ID (from the provided Google Sheet).
- `API_KEY`: Shared secret to guard API access. Stored both in Apps Script and as `NEXT_PUBLIC_GAS_API_KEY`.
- `PASSWORD_PEPPER`: Random string appended before hashing.
- Deploy as a **Web App**, access: *Anyone with the link*.

### Endpoints

All endpoints accept JSON and return `{ success, data?, error? }`. Requests must include header `x-api-key`.

| Method | action           | Payload / Query                                            | Description |
|--------|------------------|------------------------------------------------------------|-------------|
| `GET`  | `ping`           | —                                                          | Health check. |
| `POST` | `register`       | `{ role, fullName, email, password, gender, birthdate, classCode? }` | Creates user; students require valid class code. |
| `POST` | `login`          | `{ email, password }`                                      | Returns `{ token, user }`. |
| `POST` | `createClass`    | `{ token, className }`                                     | Instructors only. Generates class code. |
| `GET`  | `listClasses`    | `?token=...`                                               | Instructor classes (metadata). |
| `GET`  | `classRoster`    | `?token=...&classId=...`                                   | Instructor: students + latest evaluations. |
| `GET`  | `studentDashboard` | `?token=...`                                            | Student: latest results w/ standards. |
| `POST` | `recordTest`     | `{ token, testType, value, extra }`                        | Stores result, computes BMI/grip ratio & evaluation. |
| `GET`  | `standards`      | `?token=...`                                               | Returns all standard rows (cached in Next.js). |

### Token Structure

Tokens encode `{ userId, role, exp }`. On issue, Apps Script generates random 32-byte secret (`TOKEN_SECRET`) stored in script properties. Validation recomputes HMAC to verify signature.

## 4. Standards Loading Strategy

- `Standards` sheet is populated via `initializeStandards()` Apps Script function that reads structured objects embedded in the script (transcribed from `18.pdf`).
- Next.js caches standards client-side using SWR and uses them to label evaluation history without recomputing on every render.

## 5. Next.js Application Structure (`src/`)

```
src/
 ├─ app/
 │   ├─ layout.tsx               # Shell with global providers
 │   ├─ page.tsx                 # Landing page + login/register CTA
 │   ├─ dashboard/
 │   │   ├─ page.tsx             # Conditional rendering per role
 │   │   ├─ tests/
 │   │   │   └─ page.tsx         # Test submission wizard
 │   └─ classes/
 │       └─ page.tsx             # Instructor class management
 ├─ components/
 │   ├─ forms/                   # Reusable form primitives
 │   ├─ dashboard/               # Visualization widgets
 │   └─ layout/
 ├─ lib/
 │   ├─ api.ts                   # Fetch helpers for GAS
 │   ├─ auth.ts                  # Session utilities (token storage)
 │   ├─ standards.ts             # Type guards + evaluation helpers
 │   └─ constants.ts             # Shared enums
 └─ providers/
     └─ session-provider.tsx     # React context for user session
```

Tailwind preset is configured through `globals.css`. Form validation uses `zod` + `react-hook-form`.

## 6. Fitness Test Workflow

1. Student opens `dashboard/tests`, enters measurements (height, weight, etc.).
2. Client posts to `recordTest`. Apps Script:
   - Normalizes value (`BMI = weight / height²`, `gripRatio = gripKg / bodyWeightKg`).
   - Looks up matching standards row (by gender, age range, test type).
   - Computes `evaluation` and writes to `TestResults`.
3. Response returns updated user results; client updates dashboard charts.

## 7. Security & Validation

- All forms validated client-side and server-side. Apps Script rejects missing fields, invalid class codes, or unauthorized actions.
- Rate-limited by simple IP throttle (per minute) using Script Cache API.
- Passwords hashed with SHA-256 + pepper before storage.
- Tokens expire after 12 hours; refresh by re-login.

## 8. Deployment Considerations

- Next.js deployed to Vercel. Environment variables:
  - `NEXT_PUBLIC_GAS_BASE_URL`
  - `NEXT_PUBLIC_GAS_API_KEY`
- Apps Script must enable Google Sheets & Script APIs (default).
- Optionally enable CORS by responding with `Access-Control-Allow-Origin: *`.

## 9. Outstanding Questions / Assumptions

- Email verification is out of scope; assume trusted environment.
- Single instructor per class.
- Standards dataset is static; updates require re-running initializer.
- PDF reporting is optional; placeholder hook provided for future integration.

